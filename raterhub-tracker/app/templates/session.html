<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Session Details ‚Äì RaterHub Tracker</title>
    <style>
        :root {
            --bg: #f7f4ff;
            --card-bg: #ffffff;
            --accent: #6c5ce7;
            --accent-soft: #f0eaff;
            --accent-dark: #4b3b86;
            --text-main: #2f2940;
            --text-muted: #7a748f;
            --border-subtle: #e5defa;
            --good: #2ecc71;
            --warn: #f39c12;
            --bad: #e74c3c;
        }

        * { box-sizing: border-box; }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 24px;
        }

        .page {
            max-width: 1080px;
            margin: 0 auto;
        }

        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .nav-logo {
            font-weight: 600;
            color: #4b3b86;
        }
        .nav-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .nav-right a {
            font-size: 13px;
            color: #6c5ce7;
            text-decoration: none;
        }
        .nav-right a:hover {
            text-decoration: underline;
        }
        .nav-user {
            font-size: 12px;
            color: #4b3b86;
            background: #e9e3ff;
            padding: 6px 10px;
            border-radius: 999px;
        }

        header {
            margin-bottom: 20px;
        }

        h1 {
            margin: 0 0 6px 0;
            color: var(--accent-dark);
            font-size: 22px;
        }

        .subtitle {
            margin: 0;
            color: var(--text-muted);
            font-size: 13px;
        }

        a.back-link {
            font-size: 12px;
            color: var(--accent);
            text-decoration: none;
        }

        a.back-link:hover {
            text-decoration: underline;
        }

        .top-row {
            display: flex;
            flex-wrap: wrap;
            gap: 14px;
            margin-top: 10px;
            align-items: center;
        }

        .pace-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            padding: 6px 10px;
            border-radius: 999px;
            background: var(--accent-soft);
            color: var(--accent-dark);
        }

        .score-pill {
            font-size: 12px;
            padding: 4px 9px;
            border-radius: 999px;
            font-weight: 500;
        }

        .score-good {
            background: #e7f7ef;
            color: var(--good);
        }

        .score-mid {
            background: #fff6e5;
            color: var(--warn);
        }

        .score-bad {
            background: #ffecec;
            color: var(--bad);
        }

        .status-pill {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 999px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .status-pill.active {
            background: #e6f7ff;
            color: #007acc;
        }

        .status-pill.ended {
            background: #eef9f1;
            color: #2e7d32;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 14px;
            margin: 18px 0 24px 0;
        }

        .summary-card {
            background: var(--card-bg);
            border-radius: 14px;
            padding: 14px 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            border: 1px solid var(--border-subtle);
        }

        .summary-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .summary-value {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-main);
        }

        .summary-extra {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .section-title {
            font-size: 16px;
            color: var(--accent-dark);
            margin: 12px 0 8px 0;
        }

        .section-subtitle {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            background: var(--card-bg);
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }

        th, td {
            padding: 8px 10px;
            font-size: 12px;
            border-bottom: 1px solid #f1edf9;
        }

        th {
            background: var(--accent-soft);
            color: var(--accent-dark);
            text-align: left;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:nth-child(even) {
            background: #fbf9ff;
        }

        .q-index {
            font-weight: 600;
            color: var(--accent-dark);
        }

        .q-time {
            font-variant-numeric: tabular-nums;
        }

        .over-under {
            font-variant-numeric: tabular-nums;
        }

        .over {
            color: var(--bad);
        }

        .under {
            color: var(--good);
        }

        .on-target {
            color: var(--text-muted);
        }

        .empty-state {
            font-size: 13px;
            color: var(--text-muted);
            padding: 12px 14px;
            background: rgba(255,255,255,0.7);
            border-radius: 10px;
            border: 1px dashed var(--border-subtle);
        }

        .sparkline-bar {
            margin-top: 8px;
            height: 7px;
            border-radius: 999px;
            background: var(--accent-soft);
            overflow: hidden;
            position: relative;
        }

        .sparkline-fill {
            height: 100%;
            border-radius: inherit;
            background: linear-gradient(90deg, #a66bff, #ff6ec7);
        }

        /* New: delete button for question rows */
        .row-actions {
            text-align: center;
            width: 36px;
        }

        .question-delete-btn {
            border: none;
            background: none;
            color: #b00020;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            padding: 0;
        }

        .question-delete-btn:hover {
            color: #ff1744;
        }
    </style>
</head>
<body>
<div class="nav">
    <div class="nav-left">
        <span class="nav-logo">üíú RaterHub Tracker</span>
    </div>
    <div class="nav-right">
        <span class="nav-user">Logged in as {{ current_user_email or 'Unknown user' }}</span>
        <a href="/dashboard/today">Today</a>
        <a href="/admin/dashboard">Admin</a>
                <a href="/profile">Preferences</a>
        <a href="/logout">Logout</a>
    </div>
</div>
<div class="page">
    <header>
        <a href="/dashboard/today" class="back-link">‚Üê Back to today‚Äôs metrics</a>
        <h1>Session Details</h1>
        <p class="subtitle">
            Session ID: {{ summary.session_id }}<br>
            Started: {{ summary.started_at }}{% if summary.ended_at %} ‚Ä¢ Ended: {{ summary.ended_at }}{% endif %}
        </p>

        <div class="top-row">
            <div class="pace-chip">
                <span>{{ summary.pace_emoji }}</span>
                <span>{{ summary.pace_label }}</span>
            </div>

            {% set score = summary.score or 0 %}
            <span class="score-pill
                {% if score >= 80 %}score-good
                {% elif score >= 50 %}score-mid
                {% else %}score-bad
                {% endif %}
            ">
                Score: {{ score }}/100
            </span>

            <span class="status-pill {{ 'active' if summary.is_active else 'ended' }}">
                {{ "ACTIVE" if summary.is_active else "ENDED" }}
            </span>
        </div>
    </header>

    <!-- High-level summary -->
    <div class="summary-grid">
        <div class="summary-card">
            <div class="summary-label">Questions</div>
            <div class="summary-value">{{ summary.total_questions or 0 }}</div>
            <div class="summary-extra">
                Total rated in this session
            </div>
        </div>

        <div class="summary-card">
            <div class="summary-label">Avg active time / question</div>
            <div class="summary-value">{{ summary.avg_active_mmss }}</div>
            <div class="summary-extra">
                Target: {{ "%.1f" % (summary.target_minutes_per_question or 5.5) }} min
            </div>
        </div>

        <div class="summary-card">
            <div class="summary-label">Total active time</div>
            <div class="summary-value">
                {% set total_secs = summary.total_active_seconds or 0 %}
                {% set mins = (total_secs // 60) | int %}
                {% set secs = (total_secs - mins * 60) | int %}
                {{ "%02d:%02d" | format(mins, secs) }}
            </div>
            <div class="summary-extra">
                Pauses are excluded from this total
                <div class="sparkline-bar">
                    {% set q = summary.total_questions or 0 %}
                    {% set avg = summary.avg_active_seconds or 0 %}
                    {% set target = (summary.target_minutes_per_question or 5.5) * 60 %}
                    {% set ratio = (avg / target) if target > 0 else 0 %}
                    {% if ratio < 0 %}{% set ratio = 0 %}{% endif %}
                    {% if ratio > 2 %}{% set ratio = 2 %}{% endif %}
                    <div class="sparkline-fill" style="width: {{ (ratio * 100) }}%;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Per-question breakdown -->
    <h2 class="section-title">Per-Question Timing</h2>
    <p class="section-subtitle">
        Active time excludes pauses. ‚ÄúŒî vs target‚Äù compares each question to the
        {{ "%.1f" % (summary.target_minutes_per_question or 5.5) }} minute target.
    </p>

{% if not summary.questions %}
    <div class="empty-state">
        No questions recorded for this session yet.
    </div>
{% else %}
    <table>
        <thead>
            <tr>
                <th>#</th>
                <th>Started</th>
                <th>Ended</th>
                <th>Active time</th>
                <th>Œî vs target</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for q in summary.questions %}
                {% set delta = q.over_under_target_seconds or 0 %}
                <tr>
                    <td class="q-index">{{ q.index }}</td>
                    <td>{{ q.started_at }}</td>
                    <td>{{ q.ended_at }}</td>
                    <td class="q-time">{{ q.active_mmss }}</td>
                    <td class="over-under">
                        {% if delta > 5 %}
                            <span class="over">+{{ q.over_under_target_mmss }}</span>
                        {% elif delta < -5 %}
                            <span class="under">-{{ q.over_under_target_mmss }}</span>
                        {% else %}
                            <span class="on-target">‚âà on target</span>
                        {% endif %}
                    </td>
                    <td>
                        <form method="post"
                              action="/dashboard/sessions/{{ summary.session_id }}/questions/{{ q.id }}/delete"
                              style="display:inline;">
                            <button type="submit"
                                    onclick="return confirm('Delete this question from the session?');"
                                    title="Delete this question">
                                ‚úï
                            </button>
                        </form>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
{% endif %}
</div>
</body>
</html>
